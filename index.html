<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>BlueNav Essaouira ‚Äî Plateforme compl√®te</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#020617; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --card:#071025; --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:linear-gradient(180deg,#071228 0,#020617 100%); color:var(--text); padding:18px;}
    .wrap{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:50px;height:50px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,#22d3ee,#0ea5e9);box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(148,163,184,0.12);cursor:pointer;color:var(--muted)}
    .tab.active{background:linear-gradient(90deg,#022f3d33,#06253366);border-color:var(--accent);color:var(--text)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:12px; border:1px solid rgba(255,255,255,0.03)}
    #map{height:520px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .zones-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:260px;overflow:auto}
    .zone-item{display:flex;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(34,211,238,0.03);border:1px solid rgba(34,211,238,0.06)}
    .btn{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:#001; font-weight:600}
    .small{padding:6px 8px;font-size:13px}
    .market-list{display:flex;flex-direction:column;gap:8px}
    .market-card{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
    .chat-box{position:fixed;right:20px;bottom:20px;width:360px;max-height:70vh;border-radius:12px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;background:#071126}
    .chat-header{padding:10px 12px;background:linear-gradient(90deg,#022f3d,#052a3a);display:flex;align-items:center;gap:8px}
    .messages{padding:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .msg{padding:8px 10px;border-radius:10px;max-width:80%}
    .msg.user{align-self:flex-end;background:linear-gradient(90deg,#06b6d4,#22c55e);color:#041217}
    .msg.bot{align-self:flex-start;background:rgba(255,255,255,0.03)}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
    .form-row{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none}
    .doc-actions{display:flex;gap:8px;flex-wrap:wrap}
    footer{margin-top:8px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    /* IA bubble button */
    .ia-bubble{position:fixed;right:26px;bottom:26px;width:64px;height:64px;border-radius:999px;background:linear-gradient(90deg,#22d3ee,#0ea5e9);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;box-shadow:0 8px 30px rgba(34,211,238,0.14)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üåä</div>
        <div>
          <div style="font-weight:700;font-size:18px">BlueNav Essaouira</div>
          <div style="font-size:13px;color:var(--muted)">Waze de la p√™che ‚Äî Essaouira (port) ‚Ä¢ Prototype</div>
        </div>
      </div>

      <nav id="tabs" aria-label="navigation">
        <button class="tab active" data-tab="fisher">P√™che & Conditions</button>
        <button class="tab" data-tab="market">March√© Virtuel</button>
        <button class="tab" data-tab="assistant">Assistant IA</button>
        <button class="tab" data-tab="docs">Documents & Fiche</button>
      </nav>
    </header>

    <main class="grid">
      <!-- LEFT COLUMN: Controls / KPIs -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Param√®tres de sortie</strong>
            <button id="simulateBtn" class="btn small">Simuler sortie</button>
          </div>

          <div class="form-row">
            <label>Vitesse moyenne (n≈ìuds)</label>
            <input id="boatSpeed" type="number" value="7" min="3" max="15" />
          </div>

          <div class="form-row">
            <label>Prix carburant (MAD/L)</label>
            <input id="fuelPrice" type="number" value="11.2" step="0.1" />
          </div>

          <div class="form-row">
            <label>Conditions m√©t√©o (d√©mo)</label>
            <select id="seaCondition">
              <option value="calme">Calme</option>
              <option value="moderee" selected>Houle mod√©r√©e</option>
              <option value="forte">Houle forte</option>
            </select>
          </div>

          <div style="margin-top:10px">
            <strong>Zones recommand√©es</strong>
            <div class="zones-list" id="zonesList"></div>
          </div>
        </div>

        <!-- MARKETPLACE PREVIEW -->
        <div class="card" id="marketCard" style="margin-top:12px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>March√© virtuel ‚Äî Offres r√©centes</strong>
            <button id="newOfferBtn" class="btn small">Nouvelle offre</button>
          </div>
          <div style="margin-top:8px" class="market-list" id="marketList"></div>
        </div>

        <!-- DOCS QUICK -->
        <div class="card" id="docsCard" style="margin-top:12px;display:none">
          <strong>Documents & Fiches</strong>
          <p style="color:var(--muted);font-size:13px;margin-top:6px">Autorisation, fiche de capture et mod√®les pr√™ts √† t√©l√©charger / remplir.</p>

          <div class="doc-actions" style="margin-top:8px">
            <button id="downloadAuthBtn" class="btn small">T√©l√©charger mod√®le autorisation</button>
            <button id="downloadFicheBtn" class="btn small">T√©l√©charger fiche capture</button>
            <button id="uploadDocBtn" class="tab small">Uploader un document</button>
            <input type="file" id="docFile" style="display:none" />
          </div>

          <div style="margin-top:10px">
            <strong>Fiche rapide (remplir)</strong>
            <div class="form-row">
              <label>Zone</label><select id="zoneSelect"></select>
              <label>Esp√®ce</label><input id="speciesInput" placeholder="Sardine..." />
              <label>Quantit√© (kg)</label><input id="qtyInput" type="number" />
              <label>Prix (MAD/kg)</label><input id="priceInput" type="number" />
              <button id="saveCatchBtn" class="btn small" style="margin-top:8px">Enregistrer</button>
            </div>
          </div>
        </div>

        <!-- MARKET CHAT CONTAINER HIDDEN -->
        <div id="marketChatContainer" style="display:none; margin-top:12px">
          <!-- injected when needed -->
        </div>
      </div>

      <!-- RIGHT COLUMN: Map + domain-specific panels -->
      <div>
        <div class="card" id="mapCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong id="mapTitle">Carte & positions (Port d'Essaouira)</strong>
            <div style="font-size:13px;color:var(--muted)">Source port: ANP ‚Äî Port d'Essaouira</div>
          </div>

          <div id="map" style="margin-top:10px"></div>
        </div>

        <!-- FISHERIES DOMAIN DETAILS -->
        <div class="card" id="fisherDomain" style="margin-top:12px">
          <h3>Focus P√™che & Conditions</h3>
          <p style="color:var(--muted)">Affiche m√©t√©o, alertes, zones interdites, conseils de s√©curit√© et estimation √©conomique.</p>

          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <div style="min-width:180px">
              <strong>M√©t√©o (d√©mo)</strong>
              <div id="weatherBox" style="margin-top:6px;color:var(--muted)">Houle mod√©r√©e ¬∑ Vent 18 nd ¬∑ Visibilit√© OK</div>
            </div>

            <div style="min-width:180px">
              <strong>Conseil rapide</strong>
              <div id="adviceBox" style="margin-top:6px;color:var(--muted)">Zone B recommand√©e ‚Äî √©viter zones √† l'Est si vent > 20 nd.</div>
            </div>

            <div style="min-width:180px">
              <strong>Risque</strong>
              <div id="riskBox" style="margin-top:6px;color:#f59e0b">Risque mod√©r√©</div>
            </div>
          </div>
        </div>

        <!-- MARKETPLACE DOMAIN -->
        <div class="card" id="marketDomain" style="margin-top:12px;display:none">
          <h3>March√© virtuel ‚Äî Acheteurs & Vendeurs</h3>
          <p style="color:var(--muted)">Publie une offre (vente/achat), contacte instantan√©ment un acheteur/vendeur via un chat d√©di√©.</p>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Type</label>
              <select id="offerType"><option value="sell">Vendre</option><option value="buy">Acheter</option></select>
              <label>Esp√®ce</label><input id="offerSpecies" />
              <label>Quantit√© (kg)</label><input id="offerQty" type="number" />
              <label>Prix (MAD/kg)</label><input id="offerPrice" type="number" />
              <button id="postOfferBtn" class="btn small" style="margin-top:8px">Publier</button>
            </div>

            <div style="width:320px">
              <strong>Offres r√©centes</strong>
              <div id="offersList" style="margin-top:8px;max-height:200px;overflow:auto"></div>
            </div>
          </div>
        </div>

        <!-- ASSISTANT DOMAIN -->
        <div class="card" id="assistantDomain" style="margin-top:12px;display:none">
          <h3>Assistant IA ‚Äî Chat 24/7 (prototype)</h3>
          <p style="color:var(--muted)">Pose une question : m√©t√©o, co√ªt carburant, autorisations, conseils s√©curit√©.</p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="assistantInput" placeholder="Ex : Est-ce que je peux sortir aujourd'hui ?" />
            <button id="askAssistantBtn" class="btn small">Demander</button>
          </div>
          <div id="assistantAnswer" style="margin-top:10px;color:var(--muted)">R√©ponse de l'assistant ici...</div>
        </div>

      </div>
    </main>

    <footer>
      <div>Prototype BlueNav Essaouira ‚Ä¢ Int√®gre donn√©es portuaires (ANP Port d'Essaouira) et BMC projet. :contentReference[oaicite:2]{index=2} :contentReference[oaicite:3]{index=3}</div>
      <div style="color:var(--muted)">D√©monstration locale ‚Äî pr√™t pour int√©gration API m√©t√©o / GPS / backend</div>
    </footer>
  </div>

  <!-- IA bubble (opens chat window) -->
  <div class="ia-bubble" id="iaBubble" title="Assistant BlueNav">ü§ñ</div>

  <!-- Chat box (hidden by default) -->
  <div id="chatBox" class="chat-box" style="display:none">
    <div class="chat-header"><strong>Assistant BlueNav</strong><div style="margin-left:auto;color:var(--muted);font-size:13px">24/7</div></div>
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input id="chatInput" style="flex:1;border-radius:8px;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)"/>
      <button id="sendChatBtn" class="btn small">Envoyer</button>
    </div>
  </div>

<script>
/* ===========================
   Donn√©es & param√®tres init
   =========================== */
const ESSAOUIRA_PORT = [31.5133, -9.7696]; // coordonn√©es port (ANP)
let zones = [
  { id:'Z1', name:'Banc Nord', lat:31.54, lng:-9.78, expectedYieldKg:320, risk:0.35, price:12.5 },
  { id:'Z2', name:'Cap Sim (large)', lat:31.40, lng:-9.87, expectedYieldKg:540, risk:0.55, price:13.8 },
  { id:'Z3', name:'Large Sud', lat:31.45, lng:-9.90, expectedYieldKg:780, risk:0.7, price:11.9 },
  { id:'Z4', name:'Zone c√¥ti√®re Est', lat:31.52, lng:-9.73, expectedYieldKg:180, risk:0.2, price:10.4 }
];

const ECON = { fuelConsumptionLPerHour:9, averageCostFactor:0.15 };

/* ===========================
   Utils : distance (haversine)
   =========================== */
function distanceKm(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ===========================
   Map init
   =========================== */
let map = L.map('map').setView(ESSAOUIRA_PORT, 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
L.circleMarker(ESSAOUIRA_PORT,{radius:6,color:'#22d3ee',fillColor:'#22d3ee',fillOpacity:0.9}).addTo(map).bindPopup("Port d'Essaouira (ANP)");

const zoneCircles = {};
function drawZones(){
  zones.forEach(z=>{
    if(zoneCircles[z.id]) return;
    const circle = L.circle([z.lat,z.lng],{radius:800,color:'rgba(56,189,248,0.7)',fillColor:'rgba(56,189,248,0.18)',fillOpacity:0.6}).addTo(map)
      .bindPopup(`<strong>${z.name}</strong><br>Distance ~ ${distanceKm(ESSAOUIRA_PORT[0],ESSAOUIRA_PORT[1],z.lat,z.lng).toFixed(1)} km<br>Rendement esp√©r√© : ${z.expectedYieldKg} kg`);
    circle.on('click',()=>{ document.getElementById('zoneSelect').value = z.id; circle.openPopup() });
    zoneCircles[z.id]=circle;
  });
}
drawZones();

/* ===========================
   Zone scoring & UI render
   =========================== */
function computeScore(z, boatSpeed, fuelPrice){
  const dist = distanceKm(ESSAOUIRA_PORT[0],ESSAOUIRA_PORT[1],z.lat,z.lng)*2;
  const speedKmH = boatSpeed * 1.852;
  const travelTime = dist / speedKmH;
  const fuelCost = travelTime * ECON.fuelConsumptionLPerHour * fuelPrice;
  const revenue = z.expectedYieldKg * z.price;
  const variableCosts = z.expectedYieldKg * ECON.averageCostFactor;
  const riskPenalty = z.risk * 0.25 * revenue;
  const profit = revenue - (fuelCost + variableCosts + riskPenalty);
  const score = Math.max(0, Math.min(10, (profit/10000)*10));
  return {score: Number(score.toFixed(1)), fuelCost: Number(fuelCost.toFixed(1)), travelTime: Number(travelTime.toFixed(1)), revenue:Math.round(revenue), profit:Math.round(profit)};
}

function renderZonesList(){
  const container = document.getElementById('zonesList'); container.innerHTML='';
  const boatSpeed = Number(document.getElementById('boatSpeed').value);
  const fuelPrice = Number(document.getElementById('fuelPrice').value);
  const scored = zones.map(z=>({z,metrics:computeScore(z,boatSpeed,fuelPrice)})).sort((a,b)=>b.metrics.score-a.metrics.score);
  scored.forEach(s=>{
    const el = document.createElement('div'); el.className='zone-item';
    el.innerHTML = `<div><div style="font-weight:600">${s.z.name} (${distanceKm(ESSAOUIRA_PORT[0],ESSAOUIRA_PORT[1],s.z.lat,s.z.lng).toFixed(1)} km)</div>
      <div style="color:var(--muted);font-size:13px">Rendement: ${s.metrics.revenue} MAD ¬∑ Risque: ${(s.z.risk*100).toFixed(0)}%</div></div>
      <div style="text-align:right"><div style="font-weight:700">${s.metrics.score}/10</div><div style="color:var(--muted);font-size:13px">Carb: ${s.metrics.fuelCost} MAD</div></div>`;
    container.appendChild(el);
  });
}

/* ===========================
   Populate selects and trips
   =========================== */
function populateZoneSelect(){
  const sel = document.getElementById('zoneSelect'); sel.innerHTML='';
  zones.forEach(z=>{ const o=document.createElement('option'); o.value=z.id; o.textContent=z.name; sel.appendChild(o) });
}
populateZoneSelect();
renderZonesList();

/* ===========================
   MAP add zone on click (via ctrl+click)
   =========================== */
map.on('click', function(e){
  if(!window.addZoneMode) return;
  const lat=e.latlng.lat, lng=e.latlng.lng;
  const name = prompt('Nom de la nouvelle zone:','Nouvelle zone');
  if(!name) { alert('Annul√©'); window.addZoneMode=false; document.getElementById('addZoneBtn') && (document.getElementById('addZoneBtn').textContent='Ajouter zone'); return; }
  const newId = 'Z' + (zones.length+1);
  const newZone={id:newId,name,lat,lng,expectedYieldKg:300,risk:0.4,price:12};
  zones.push(newZone);
  const circle=L.circle([lat,lng],{radius:800,color:'rgba(56,189,248,0.7)',fillColor:'rgba(56,189,248,0.18)',fillOpacity:0.6}).addTo(map).bindPopup(`<strong>${name}</strong>`);
  circle.on('click',()=>{document.getElementById('zoneSelect').value=newId;circle.openPopup()});
  zoneCircles[newId]=circle;
  populateZoneSelect(); renderZonesList();
  window.addZoneMode=false;
  alert('Zone ajout√©e');
});

/* ===========================
   Tabs logic
   =========================== */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', (ev)=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const tab=t.getAttribute('data-tab');
  // show/hide panels
  document.getElementById('marketCard').style.display = tab==='market'?'block':'none';
  document.getElementById('docsCard').style.display = tab==='docs'?'block':'none';
  document.getElementById('marketDomain').style.display = tab==='market'?'block':'none';
  document.getElementById('assistantDomain').style.display = tab==='assistant'?'block':'none';
  // fisher visible always (we keep it)
}));

/* ===========================
   Simulation button
   =========================== */
document.getElementById('simulateBtn').addEventListener('click', ()=> {
  renderZonesList();
  alert('Simulation lanc√©e ‚Äî voir zones recommand√©es');
});

/* ===========================
   Marketplace (local prototype)
   =========================== */
let offers = [
  {id:1,type:'sell',species:'Sardine',qty:200,price:12,owner:'P√™cheur A'},
  {id:2,type:'buy',species:'Daurade',qty:50,price:30,owner:'Acheteur B'}
];

function renderOffers(){
  const list = document.getElementById('offersList'); list.innerHTML='';
  offers.slice().reverse().forEach(o=>{
    const div=document.createElement('div'); div.className='market-card';
    div.innerHTML=`<div style="display:flex;justify-content:space-between"><div><strong>${o.type==='sell'?'VEND':'ACHETE'} ${o.species}</strong><div style="color:var(--muted);font-size:13px">${o.qty} kg ‚Ä¢ ${o.price} MAD/kg</div></div>
      <div style="display:flex;flex-direction:column;gap:6px"><button class="tab small" onclick="openMarketChat(${o.id})">Contacter</button></div></div>`;
    list.appendChild(div);
  });
  // also feed left panel list
  const marketList = document.getElementById('marketList'); if(marketList){ marketList.innerHTML=''; offers.slice().reverse().forEach(o=>{
    const el=document.createElement('div'); el.className='market-card'; el.textContent = `${o.owner} ‚Ä¢ ${o.type==='sell'?'VEND':'ACHETE'} ${o.species} ‚Ä¢ ${o.qty}kg ‚Ä¢ ${o.price} MAD/kg`; marketList.appendChild(el);
  }) }
}
renderOffers();

document.getElementById('postOfferBtn').addEventListener('click', ()=>{
  const type = document.getElementById('offerType').value;
  const sp = document.getElementById('offerSpecies').value || 'Inconnue';
  const qty = Number(document.getElementById('offerQty').value) || 0;
  const price = Number(document.getElementById('offerPrice').value) || 0;
  if(qty<=0||price<=0){ alert('Quantit√© et prix requis'); return; }
  const id = offers.length?offers[offers.length-1].id+1:1;
  offers.push({id,type,species:sp,qty,price,owner:'Utilisateur'});
  renderOffers();
  alert('Offre publi√©e (prototype local)');
});

/* Simple market chat (opens a simulated chat window) */
function openMarketChat(offerId){
  const offer = offers.find(o=>o.id===offerId);
  if(!offer){ alert('Offre introuvable'); return; }
  const kont = document.getElementById('marketChatContainer');
  kont.innerHTML = `<div class="card"><strong>Chat march√© ‚Äî ${offer.type==='sell'?'Vente':'Achat'} ${offer.species}</strong>
    <div style="margin-top:8px"><div id="mcMessages" style="max-height:200px;overflow:auto;border-radius:8px;padding:8px;background:rgba(255,255,255,0.02)"></div>
    <div style="display:flex;gap:8px;margin-top:8px"><input id="mcInput" style="flex:1"/><button id="mcSend" class="btn small">Envoyer</button></div></div></div>`;
  kont.style.display='block';
  const mcSend = document.getElementById('mcSend');
  mcSend.onclick = ()=>{ const t=document.getElementById('mcInput').value; if(!t) return; const m=document.getElementById('mcMessages'); m.innerHTML += `<div style="text-align:right;color:var(--muted)"><strong>Vous:</strong> ${t}</div>`; document.getElementById('mcInput').value=''; setTimeout(()=>{ m.innerHTML += `<div style="color:var(--muted)"><strong>${offer.owner}:</strong> Merci, int√©ress√©. On se retrouve au port.</div>`; m.scrollTop = m.scrollHeight; },800) };
}

/* ===========================
   Documents download / upload
   =========================== */
document.getElementById('downloadAuthBtn').addEventListener('click', ()=>{
  const text = `MODELE - Autorisation sortie p√™che\n\nNom du p√™cheur:\nCoop√©rative:\nDate:\nZone autoris√©e:\nSignature:`;
  const blob = new Blob([text],{type:'text/plain'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='autorisation_modele.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('downloadFicheBtn').addEventListener('click', ()=>{
  const text = `FICHE CAPTURE\n\nDate:\nZone:\nEsp√®ce:\nQuantit√© (kg):\nPrix moyen (MAD/kg):\nTemps en mer (h):\nObservations:`;
  const blob=new Blob([text],{type:'text/plain'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='fiche_capture.txt'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('uploadDocBtn').addEventListener('click', ()=> document.getElementById('docFile').click());
document.getElementById('docFile').addEventListener('change', (e)=>{ if(e.target.files.length){ alert('Document upload√© (prototype local) : ' + e.target.files[0].name) } });

/* ===========================
   Save catch (local)
   =========================== */
const trips = [];
document.getElementById('saveCatchBtn').addEventListener('click', ()=>{
  const zoneId = document.getElementById('zoneSelect').value;
  const sp = document.getElementById('speciesInput').value || 'Inconnue';
  const qty = Number(document.getElementById('qtyInput').value) || 0;
  const price = Number(document.getElementById('priceInput').value) || 0;
  if(!zoneId||qty<=0||price<=0){ alert('Remplir zone, quantit√© et prix'); return; }
  trips.push({zoneId,sp,qty,price,date: new Date().toISOString()});
  alert('Fiche enregistr√©e (local prototype)');
  // reset
  document.getElementById('speciesInput').value=''; document.getElementById('qtyInput').value=''; document.getElementById('priceInput').value='';
});

/* ===========================
   Assistant IA (prototype local)
   =========================== */
function botRespond(msg){
  const m = msg.toLowerCase();
  if(m.includes('m√©t√©o')||m.includes('vent')||m.includes('houle')) return "Aujourd'hui : houle mod√©r√©e, vent ~18 nd. √âviter sorties longues si vent > 20 nd.";
  if(m.includes('carburant')||m.includes('co√ªt')) return "Estimation carburant: utilisez la fonction de simulation pour estimer le co√ªt selon la zone et la vitesse.";
  if(m.includes('autorisation')||m.includes('papier')) return "Vous pouvez t√©l√©charger un mod√®le d'autorisation dans l'onglet Documents, le remplir et le soumettre √† la coop√©rative.";
  if(m.includes('s√©curit√©')||m.includes('danger')) return "Conseil: ne partez pas en cas de houle forte; privil√©giez sorties t√¥t le matin quand la mer est plus calme.";
  if(m.includes('comment')||m.includes('comment faire')) return "Enregistrez vos captures via la fiche, partagez avec la coop√©rative et utilisez le march√© pour vendre localement.";
  return "D√©sol√©, je n'ai pas la r√©ponse compl√®te ici. Demandez 'm√©t√©o', 'carburant', 'autorisation' ou 's√©curit√©'.";
}

document.getElementById('askAssistantBtn').addEventListener('click', ()=>{
  const q = document.getElementById('assistantInput').value || '';
  if(!q) return alert('Pose une question');
  document.getElementById('assistantAnswer').textContent = '... r√©flexion ...';
  setTimeout(()=>{ document.getElementById('assistantAnswer').textContent = botRespond(q); },600);
});

/* Chat bubble controls */
const iaBubble = document.getElementById('iaBubble'), chatBox = document.getElementById('chatBox');
iaBubble.addEventListener('click', ()=>{ chatBox.style.display = chatBox.style.display==='none'?'flex':'none'; });
document.getElementById('sendChatBtn').addEventListener('click', ()=>{
  const t = document.getElementById('chatInput').value.trim(); if(!t) return;
  const msgs = document.getElementById('messages');
  const userMsg = document.createElement('div'); userMsg.className='msg user'; userMsg.textContent = t; msgs.appendChild(userMsg);
  document.getElementById('chatInput').value='';
  setTimeout(()=>{ const botMsg=document.createElement('div'); botMsg.className='msg bot'; botMsg.textContent = botRespond(t); msgs.appendChild(botMsg); msgs.scrollTop = msgs.scrollHeight; },700);
});

/* ===========================
   UI small binds
   =========================== */
document.getElementById('recomputeBtn')?.addEventListener('click', renderZonesList);
document.getElementById('simulateBtn')?.addEventListener('click', renderZonesList);
document.getElementById('newOfferBtn')?.addEventListener('click', ()=> { document.getElementById('offerType').value='sell'; document.getElementById('offerSpecies').value='Sardine'; document.getElementById('offerQty').value=100; document.getElementById('offerPrice').value=12; document.querySelector('.tab[data-tab="market"]').click(); });
renderZonesList(); renderOffers();

</script>
</body>
</html>
